<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algoritmo Gen√©tico - Build de Personagem RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 25px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .step {
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .step:hover {
            border-color: #667eea;
            transform: translateX(3px);
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .step.completed {
            background: #d4edda;
            border-color: #28a745;
        }

        .step-number {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85em;
        }

        .step.completed .step-number {
            background: #28a745;
        }

        .step.active .step-number {
            background: white;
            color: #667eea;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }

        .control-group label {
            font-size: 0.85em;
            color: #555;
            font-weight: 600;
        }

        input[type="number"] {
            padding: 6px 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        button {
            padding: 10px 16px;
            font-size: 0.9em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            margin-top: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 12px;
            border-radius: 8px;
            color: white;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.8em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .status-message {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .status-message h3 {
            color: #2196F3;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .status-message p {
            color: #555;
            margin: 0;
            font-size: 0.95em;
        }

        .process-visualization {
            background: #fff9e6;
            border: 2px solid #ffeb3b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .process-visualization h3 {
            color: #f57c00;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .process-step {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ff9800;
        }

        .process-step:last-child {
            margin-bottom: 0;
        }

        .process-step h4 {
            color: #ff9800;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .char-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
        }

        .char-display.parent {
            background: #e3f2fd;
            border-left: 3px solid #2196F3;
        }

        .char-display.child {
            background: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        .char-display.mutated {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
        }

        .arrow {
            text-align: center;
            font-size: 1.5em;
            color: #ff9800;
            margin: 10px 0;
        }

        .best-character {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .best-character h3 {
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .attributes {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .attribute {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .attribute-name {
            font-size: 0.75em;
            opacity: 0.9;
        }

        .attribute-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .skills {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 5px;
        }

        .skills h4 {
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .skill-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .skill-tag {
            background: rgba(255,255,255,0.3);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .population-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .individual {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.3s;
        }

        .individual:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .individual.elite {
            border-color: #f39c12;
            background: linear-gradient(135deg, #fff7e6 0%, #ffe6cc 100%);
        }

        .fitness-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .fitness-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .mini-attributes {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            font-size: 0.75em;
        }

        .mini-attr {
            text-align: center;
            padding: 4px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öîÔ∏è Algoritmo Gen√©tico - Build de Personagem RPG</h1>
        <p class="subtitle">Otimiza√ß√£o de distribui√ß√£o de atributos e habilidades para maximizar efici√™ncia em combate</p>

        <div class="main-grid">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Etapas -->
                <div class="panel">
                    <h2>üß¨ Etapas</h2>
                    <div class="steps">
                        <div class="step" onclick="executeStep(0)">
                            <div class="step-number">1</div>
                            <span>Popula√ß√£o Inicial</span>
                        </div>
                        <div class="step" onclick="executeStep(1)">
                            <div class="step-number">2</div>
                            <span>Avaliar Fitness</span>
                        </div>
                        <div class="step" onclick="executeStep(2)">
                            <div class="step-number">3</div>
                            <span>Sele√ß√£o</span>
                        </div>
                        <div class="step" onclick="executeStep(3)">
                            <div class="step-number">4</div>
                            <span>Cruzamento</span>
                        </div>
                        <div class="step" onclick="executeStep(4)">
                            <div class="step-number">5</div>
                            <span>Muta√ß√£o</span>
                        </div>
                        <div class="step" onclick="executeStep(5)">
                            <div class="step-number">6</div>
                            <span>Pr√≥xima Gera√ß√£o</span>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√µes -->
                <div class="panel">
                    <h2>‚öôÔ∏è Configura√ß√µes</h2>
                    <div class="control-group">
                        <label>Popula√ß√£o</label>
                        <input type="number" id="popSize" value="20" min="10" max="50">
                    </div>
                    <div class="control-group">
                        <label>Muta√ß√£o (%)</label>
                        <input type="number" id="mutationRate" value="15" min="1" max="100">
                    </div>
                    <div class="control-group">
                        <label>Elitismo (%)</label>
                        <input type="number" id="eliteRate" value="10" min="0" max="50">
                    </div>

                    <button class="btn-primary" onclick="nextStep()">‚ñ∂Ô∏è Pr√≥ximo Passo</button>
                    <button class="btn-success" id="btnAuto" onclick="runAutomatically()">‚ö° Autom√°tico</button>
                    <button class="btn-danger" id="btnStop" onclick="stopAutomatically()" style="display: none;">‚è∏Ô∏è Parar</button>
                    <button class="btn-danger" onclick="reset()">üîÑ Reiniciar</button>
                </div>

                <!-- Estat√≠sticas -->
                <div class="panel">
                    <h2>üìä Estat√≠sticas</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Gera√ß√£o</h3>
                            <div class="value" id="generation">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Melhor</h3>
                            <div class="value" id="bestFitness">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √Årea Principal -->
            <div class="content">
                <!-- Mensagem de Status -->
                <div class="status-message" id="statusMessage">
                    <h3>Bem-vindo!</h3>
                    <p>Clique em "Popula√ß√£o Inicial" para come√ßar.</p>
                </div>

                <!-- Visualiza√ß√£o do Processo -->
                <div id="processVisualization"></div>

                <!-- Melhor Solu√ß√£o -->
                <div class="panel">
                    <h2>üèÜ Melhor Build Atual</h2>
                    <div id="bestCharacterDisplay">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Execute a primeira etapa para ver o melhor personagem
                        </p>
                    </div>
                </div>

                <!-- Popula√ß√£o -->
                <div class="panel">
                    <h2>üë• Popula√ß√£o Atual</h2>
                    <div class="population-grid" id="populationDisplay">
                        <p style="text-align: center; color: #666; padding: 20px; grid-column: 1/-1;">
                            Execute a primeira etapa para ver a popula√ß√£o
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const TOTAL_POINTS = 100;
        const MAX_ATTR_VALUE = 50;
        const SKILLS = [
            { name: 'Golpe Poderoso', reqStr: 15, reqDex: 0, reqInt: 0 },
            { name: 'Ataque R√°pido', reqStr: 10, reqDex: 15, reqInt: 0 },
            { name: 'Bola de Fogo', reqStr: 0, reqDex: 0, reqInt: 20 },
            { name: 'Escudo Arcano', reqStr: 0, reqDex: 5, reqInt: 15 },
            { name: 'Cura Divina', reqStr: 0, reqDex: 0, reqInt: 25 },
            { name: 'F√∫ria Berserker', reqStr: 25, reqDex: 10, reqInt: 0 },
            { name: 'Esquiva Perfeita', reqStr: 5, reqDex: 25, reqInt: 5 },
            { name: 'Raio Arcano', reqStr: 0, reqDex: 10, reqInt: 30 },
            { name: 'Contra-Ataque', reqStr: 15, reqDex: 20, reqInt: 0 },
            { name: 'Invoca√ß√£o', reqStr: 5, reqDex: 5, reqInt: 35 }
        ];

        let population = [];
        let generation = 0;
        let currentStep = -1;
        let selectedParents = [];
        let children = [];
        let isRunning = false;
        let processDetails = {};
        let lastBestFitness = 0;
        let generationsWithoutImprovement = 0;

        class Character {
            constructor(strength, dexterity, intelligence, vitality, luck) {
                const total = strength + dexterity + intelligence + vitality + luck;
                const factor = total > 0 ? TOTAL_POINTS / total : 1;

                this.strength = Math.min(MAX_ATTR_VALUE, Math.round(strength * factor));
                this.dexterity = Math.min(MAX_ATTR_VALUE, Math.round(dexterity * factor));
                this.intelligence = Math.min(MAX_ATTR_VALUE, Math.round(intelligence * factor));
                this.vitality = Math.min(MAX_ATTR_VALUE, Math.round(vitality * factor));
                this.luck = Math.min(MAX_ATTR_VALUE, Math.round(luck * factor));

                this.adjustTotal();
                this.skills = this.determineSkills();
                this.fitness = 0;
            }

            adjustTotal() {
                let currentTotal = this.strength + this.dexterity + this.intelligence + this.vitality + this.luck;
                while (currentTotal !== TOTAL_POINTS) {
                    if (currentTotal < TOTAL_POINTS) {
                        const attrs = ['strength', 'dexterity', 'intelligence', 'vitality', 'luck'];
                        const randomAttr = attrs[Math.floor(Math.random() * attrs.length)];
                        if (this[randomAttr] < MAX_ATTR_VALUE) this[randomAttr]++;
                    } else {
                        const attrs = ['strength', 'dexterity', 'intelligence', 'vitality', 'luck'];
                        const randomAttr = attrs[Math.floor(Math.random() * attrs.length)];
                        if (this[randomAttr] > 0) this[randomAttr]--;
                    }
                    currentTotal = this.strength + this.dexterity + this.intelligence + this.vitality + this.luck;
                }
            }

            determineSkills() {
                return SKILLS.filter(skill =>
                    this.strength >= skill.reqStr &&
                    this.dexterity >= skill.reqDex &&
                    this.intelligence >= skill.reqInt
                );
            }

            calculateFitness() {
                const hp = 100 + (this.vitality * 10);
                const physicalDamage = this.strength * 2 + this.dexterity * 1.5;
                const magicalDamage = this.intelligence * 2.5;
                const totalDamage = physicalDamage + magicalDamage;
                const critRate = (this.luck + this.dexterity) / 200;
                const critMultiplier = 1 + critRate;
                const defense = this.vitality * 1.5 + this.strength * 0.5;
                const skillBonus = this.skills.length * 50;
                const avg = TOTAL_POINTS / 5;
                const variance = Math.pow(this.strength - avg, 2) +
                                Math.pow(this.dexterity - avg, 2) +
                                Math.pow(this.intelligence - avg, 2) +
                                Math.pow(this.vitality - avg, 2) +
                                Math.pow(this.luck - avg, 2);
                const synergyPenalty = variance / 100;

                this.fitness = Math.round(
                    (hp * 0.3) + (totalDamage * critMultiplier * 2) +
                    (defense * 0.5) + skillBonus - synergyPenalty
                );
                return this.fitness;
            }

            static random() {
                return new Character(
                    Math.random() * MAX_ATTR_VALUE,
                    Math.random() * MAX_ATTR_VALUE,
                    Math.random() * MAX_ATTR_VALUE,
                    Math.random() * MAX_ATTR_VALUE,
                    Math.random() * MAX_ATTR_VALUE
                );
            }

            clone() {
                return new Character(this.strength, this.dexterity, this.intelligence, this.vitality, this.luck);
            }

            toString() {
                return `FOR:${this.strength} DEX:${this.dexterity} INT:${this.intelligence} VIT:${this.vitality} LCK:${this.luck}`;
            }
        }

        function step0_populationInit() {
            const popSize = parseInt(document.getElementById('popSize').value);
            population = [];
            for (let i = 0; i < popSize; i++) {
                population.push(Character.random());
            }
            generation = 1;

            processDetails = {
                title: 'üé≤ Etapa 1: Popula√ß√£o Inicial',
                steps: [
                    {
                        title: 'Gera√ß√£o Aleat√≥ria',
                        description: `${popSize} personagens foram criados com atributos aleat√≥rios.`,
                        examples: population.slice(0, 3).map((c, i) =>
                            `<div class="char-display">Personagem ${i+1}: ${c.toString()} (Total: ${c.strength + c.dexterity + c.intelligence + c.vitality + c.luck} pontos)</div>`
                        ).join('')
                    }
                ]
            };

            updateStatus('Popula√ß√£o Inicial Criada', `${popSize} personagens aleat√≥rios foram criados para a gera√ß√£o 1.`);
            updateDisplay();
            showProcessVisualization();
        }

        function step1_evaluateFitness() {
            const before = population.slice(0, 3).map(c => ({ char: c.toString(), fitness: c.fitness }));

            population.forEach(char => char.calculateFitness());
            population.sort((a, b) => b.fitness - a.fitness);

            const after = population.slice(0, 3).map(c => ({ char: c.toString(), fitness: c.fitness }));

            processDetails = {
                title: 'üìä Etapa 2: Avalia√ß√£o de Fitness',
                steps: [
                    {
                        title: 'C√°lculo de Fitness',
                        description: 'Cada personagem √© avaliado com base em HP, Dano, Defesa, Habilidades e Sinergia.',
                        examples: after.map((item, i) =>
                            `<div class="char-display">
                                #${i+1}: ${item.char}<br>
                                <strong style="color: #667eea;">Fitness: ${item.fitness}</strong>
                            </div>`
                        ).join('')
                    },
                    {
                        title: 'Ordena√ß√£o',
                        description: `Popula√ß√£o ordenada do maior para o menor fitness. Melhor: ${population[0].fitness}`,
                        examples: ''
                    }
                ]
            };

            updateStatus('Popula√ß√£o Avaliada', `Fitness calculado e popula√ß√£o ordenada. Melhor: ${population[0].fitness}`);
            updateDisplay();
            showProcessVisualization();
        }

        function step2_selection() {
            selectedParents = [];
            const popSize = population.length;

            const examples = [];
            for (let i = 0; i < Math.min(3, popSize); i++) {
                const parent = tournamentSelection();
                selectedParents.push(parent);
                examples.push({
                    char: parent.toString(),
                    fitness: parent.fitness
                });
            }

            for (let i = examples.length; i < popSize; i++) {
                selectedParents.push(tournamentSelection());
            }

            processDetails = {
                title: 'üéØ Etapa 3: Sele√ß√£o por Torneio',
                steps: [
                    {
                        title: 'M√©todo: Torneio (3 competidores)',
                        description: 'Escolhe 3 personagens aleat√≥rios e seleciona o melhor como pai.',
                        examples: examples.map((p, i) =>
                            `<div class="char-display parent">
                                Pai ${i+1}: ${p.char}<br>
                                <strong>Fitness: ${p.fitness}</strong>
                            </div>`
                        ).join('')
                    },
                    {
                        title: 'Resultado',
                        description: `${selectedParents.length} pais foram selecionados para reprodu√ß√£o.`,
                        examples: ''
                    }
                ]
            };

            updateStatus('Sele√ß√£o Conclu√≠da', `${selectedParents.length} pais selecionados por torneio.`);
            showProcessVisualization();
        }

        function tournamentSelection(tournamentSize = 3) {
            const tournament = [];
            for (let i = 0; i < tournamentSize; i++) {
                tournament.push(population[Math.floor(Math.random() * population.length)]);
            }
            tournament.sort((a, b) => b.fitness - a.fitness);
            return tournament[0];
        }

        function step3_crossover() {
            children = [];
            const examples = [];

            for (let i = 0; i < Math.min(2, selectedParents.length); i += 2) {
                const parent1 = selectedParents[i];
                const parent2 = selectedParents[i + 1] || selectedParents[0];
                const child = crossover(parent1, parent2);
                children.push(child);

                if (examples.length < 2) {
                    examples.push({
                        parent1: parent1.toString(),
                        parent2: parent2.toString(),
                        child: child.toString()
                    });
                }
            }

            for (let i = examples.length * 2; i < selectedParents.length; i += 2) {
                const parent1 = selectedParents[i];
                const parent2 = selectedParents[i + 1] || selectedParents[0];
                children.push(crossover(parent1, parent2));
            }

            processDetails = {
                title: 'üß¨ Etapa 4: Cruzamento (Blend Crossover)',
                steps: examples.map((ex, i) => ({
                    title: `Cruzamento ${i+1}`,
                    description: 'Combina atributos dos pais usando m√©dia ponderada.',
                    examples: `
                        <div class="char-display parent">Pai 1: ${ex.parent1}</div>
                        <div class="char-display parent">Pai 2: ${ex.parent2}</div>
                        <div class="arrow">‚¨áÔ∏è</div>
                        <div class="char-display child">Filho: ${ex.child}</div>
                    `
                }))
            };

            processDetails.steps.push({
                title: 'Resultado',
                description: `${children.length} novos personagens gerados.`,
                examples: ''
            });

            updateStatus('Cruzamento Realizado', `${children.length} filhos gerados atrav√©s do cruzamento.`);
            showProcessVisualization();
        }

        function crossover(parent1, parent2) {
            const alpha = Math.random();
            return new Character(
                parent1.strength * alpha + parent2.strength * (1 - alpha),
                parent1.dexterity * alpha + parent2.dexterity * (1 - alpha),
                parent1.intelligence * alpha + parent2.intelligence * (1 - alpha),
                parent1.vitality * alpha + parent2.vitality * (1 - alpha),
                parent1.luck * alpha + parent2.luck * (1 - alpha)
            );
        }

        function step4_mutation() {
            const mutationRate = parseInt(document.getElementById('mutationRate').value);
            const examples = [];
            let mutationCount = 0;

            children.forEach((child, i) => {
                const before = child.toString();
                const mutated = mutate(child, mutationRate);
                if (mutated && examples.length < 3) {
                    examples.push({
                        before: before,
                        after: child.toString()
                    });
                    mutationCount++;
                } else if (mutated) {
                    mutationCount++;
                }
            });

            processDetails = {
                title: 'üîÄ Etapa 5: Muta√ß√£o',
                steps: [
                    {
                        title: `Taxa de Muta√ß√£o: ${mutationRate}%`,
                        description: 'Transfere pontos aleatoriamente entre dois atributos.',
                        examples: examples.length > 0 ? examples.map((ex, i) =>
                            `<div class="process-step">
                                <h4>Muta√ß√£o ${i+1}</h4>
                                <div class="char-display">Antes: ${ex.before}</div>
                                <div class="arrow">‚¨áÔ∏è</div>
                                <div class="char-display mutated">Depois: ${ex.after}</div>
                            </div>`
                        ).join('') : '<p style="color: #666;">Nenhuma muta√ß√£o ocorreu nesta gera√ß√£o.</p>'
                    },
                    {
                        title: 'Resultado',
                        description: `${mutationCount} de ${children.length} personagens sofreram muta√ß√£o.`,
                        examples: ''
                    }
                ]
            };

            updateStatus('Muta√ß√£o Aplicada', `${mutationCount}/${children.length} personagens mutados.`);
            showProcessVisualization();
        }

        function mutate(character, mutationRate) {
            if (Math.random() * 100 < mutationRate) {
                const attrs = ['strength', 'dexterity', 'intelligence', 'vitality', 'luck'];
                const attr1 = attrs[Math.floor(Math.random() * attrs.length)];
                let attr2 = attrs[Math.floor(Math.random() * attrs.length)];
                while (attr2 === attr1) attr2 = attrs[Math.floor(Math.random() * attrs.length)];

                const transfer = Math.floor(Math.random() * 10) + 1;
                if (character[attr1] >= transfer) {
                    character[attr1] -= transfer;
                    character[attr2] = Math.min(MAX_ATTR_VALUE, character[attr2] + transfer);
                }
                character.adjustTotal();
                character.skills = character.determineSkills();
                return true;
            }
            return false;
        }

        function step5_nextGeneration() {
            const eliteSize = Math.floor(population.length * (parseInt(document.getElementById('eliteRate').value) / 100));
            const elite = population.slice(0, eliteSize).map(char => char.clone());

            children.forEach(child => child.calculateFitness());

            const oldBest = population[0].fitness;
            population = [...elite, ...children];
            population.sort((a, b) => b.fitness - a.fitness);
            population = population.slice(0, parseInt(document.getElementById('popSize').value));

            generation++;
            const newBest = population[0].fitness;
            const improvement = ((newBest - oldBest) / oldBest * 100).toFixed(1);

            // Verificar se houve melhoria
            if (newBest > lastBestFitness) {
                lastBestFitness = newBest;
                generationsWithoutImprovement = 0;
            } else {
                generationsWithoutImprovement++;
            }

            // Parar se n√£o houver melhoria por 5 gera√ß√µes consecutivas
            if (generationsWithoutImprovement >= 5 && isRunning) {
                isRunning = false;
                updateStatus(`üéØ Converg√™ncia Alcan√ßada!`,
                    `Algoritmo convergiu ap√≥s ${generation} gera√ß√µes. Melhor fitness: ${newBest}`);
                document.getElementById('btnAuto').style.display = 'block';
                document.getElementById('btnStop').style.display = 'none';
            }

            processDetails = {
                title: 'üîÑ Etapa 6: Nova Gera√ß√£o',
                steps: [
                    {
                        title: `Elitismo (${eliteSize} melhores)`,
                        description: 'Os melhores personagens passam direto para nova gera√ß√£o.',
                        examples: elite.slice(0, 2).map((c, i) =>
                            `<div class="char-display elite">Elite ${i+1}: ${c.toString()} (Fitness: ${c.fitness})</div>`
                        ).join('')
                    },
                    {
                        title: 'Substitui√ß√£o',
                        description: `Elite + Filhos formam a nova gera√ß√£o ${generation}.`,
                        examples: `
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <strong>Gera√ß√£o Anterior:</strong> Melhor fitness = ${oldBest}<br>
                                <strong>Nova Gera√ß√£o ${generation}:</strong> Melhor fitness = ${newBest}<br>
                                <strong>Melhoria:</strong> ${improvement > 0 ? '+' : ''}${improvement}%<br>
                                ${generationsWithoutImprovement > 0 ? `<strong style="color: #ff9800;">Sem melhoria h√° ${generationsWithoutImprovement} gera√ß√£o(√µes)</strong>` : ''}
                            </div>
                        `
                    }
                ]
            };

            updateStatus(`Gera√ß√£o ${generation} Criada`, `Nova gera√ß√£o pronta! Melhoria: ${improvement}%`);
            updateDisplay();
            showProcessVisualization();
        }

        function executeStep(stepIndex) {
            if (stepIndex === 0 && currentStep === -1) {
                step0_populationInit();
                currentStep = 0;
            } else if (stepIndex === currentStep + 1) {
                switch(stepIndex) {
                    case 1: step1_evaluateFitness(); break;
                    case 2: step2_selection(); break;
                    case 3: step3_crossover(); break;
                    case 4: step4_mutation(); break;
                    case 5:
                        step5_nextGeneration();
                        currentStep = 0;
                        updateStepUI();
                        return;
                }
                currentStep = stepIndex;
            }
            updateStepUI();
        }

        function nextStep() {
            if (currentStep === -1) {
                executeStep(0);
            } else {
                executeStep(currentStep + 1);
            }
        }

        async function runAutomatically() {
            if (isRunning) return;
            isRunning = true;

            document.getElementById('btnAuto').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';

            if (currentStep === -1) {
                executeStep(0);
                await sleep(800);
            }

            for (let i = 0; i < 20; i++) {
                if (!isRunning) break;
                for (let step = 1; step <= 5; step++) {
                    if (!isRunning) break;
                    executeStep(step);
                    await sleep(400);
                }
                if (!isRunning) break;
            }

            isRunning = false;
            document.getElementById('btnAuto').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
        }

        function stopAutomatically() {
            isRunning = false;
            document.getElementById('btnAuto').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function reset() {
            population = [];
            generation = 0;
            currentStep = -1;
            selectedParents = [];
            children = [];
            isRunning = false;
            processDetails = {};
            lastBestFitness = 0;
            generationsWithoutImprovement = 0;

            document.getElementById('generation').textContent = '0';
            document.getElementById('bestFitness').textContent = '-';
            document.getElementById('bestCharacterDisplay').innerHTML =
                '<p style="text-align: center; color: #666; padding: 20px;">Execute a primeira etapa</p>';
            document.getElementById('populationDisplay').innerHTML =
                '<p style="text-align: center; color: #666; padding: 20px; grid-column: 1/-1;">Execute a primeira etapa</p>';
            document.getElementById('processVisualization').innerHTML = '';
            document.getElementById('btnAuto').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';

            updateStatus('Sistema Reiniciado', 'Clique em "Popula√ß√£o Inicial" para come√ßar.');
            updateStepUI();
        }

        function updateStepUI() {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index === currentStep) {
                    step.classList.add('active');
                } else if (index < currentStep || (currentStep === 0 && generation > 1)) {
                    step.classList.add('completed');
                }
            });
        }

        function updateStatus(title, message) {
            document.getElementById('statusMessage').innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
            `;
        }

        function showProcessVisualization() {
            if (!processDetails.title) return;

            const html = `
                <div class="process-visualization">
                    <h3>${processDetails.title}</h3>
                    ${processDetails.steps.map(step => `
                        <div class="process-step">
                            <h4>${step.title}</h4>
                            <p>${step.description}</p>
                            ${step.examples}
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('processVisualization').innerHTML = html;
        }

        function updateDisplay() {
            if (population.length === 0) return;

            document.getElementById('generation').textContent = generation;
            document.getElementById('bestFitness').textContent = population[0].fitness;

            displayBestCharacter(population[0]);
            displayPopulation();
        }

        function displayBestCharacter(char) {
            const hp = 100 + (char.vitality * 10);
            const physicalDmg = Math.round(char.strength * 2 + char.dexterity * 1.5);
            const magicalDmg = Math.round(char.intelligence * 2.5);
            const defense = Math.round(char.vitality * 1.5 + char.strength * 0.5);
            const critRate = Math.round(((char.luck + char.dexterity) / 200) * 100);

            const html = `
                <div class="best-character">
                    <h3>‚≠ê ${char.toString()}</h3>
                    <p style="margin: 8px 0; font-size: 0.95em;">Fitness: ${char.fitness} | HP: ${hp} | DEF: ${defense} | CRIT: ${critRate}%</p>
                    <div class="attributes">
                        <div class="attribute">
                            <div class="attribute-name">üí™ FOR</div>
                            <div class="attribute-value">${char.strength}</div>
                        </div>
                        <div class="attribute">
                            <div class="attribute-name">üèÉ DEX</div>
                            <div class="attribute-value">${char.dexterity}</div>
                        </div>
                        <div class="attribute">
                            <div class="attribute-name">üß† INT</div>
                            <div class="attribute-value">${char.intelligence}</div>
                        </div>
                        <div class="attribute">
                            <div class="attribute-name">‚ù§Ô∏è VIT</div>
                            <div class="attribute-value">${char.vitality}</div>
                        </div>
                        <div class="attribute">
                            <div class="attribute-name">üçÄ LCK</div>
                            <div class="attribute-value">${char.luck}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 5px; text-align: center; font-size: 0.9em;">
                            <strong>‚öîÔ∏è F√≠sico:</strong> ${physicalDmg}
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 5px; text-align: center; font-size: 0.9em;">
                            <strong>‚ú® M√°gico:</strong> ${magicalDmg}
                        </div>
                    </div>
                    <div class="skills">
                        <h4>üéØ Habilidades (${char.skills.length}):</h4>
                        <div class="skill-list">
                            ${char.skills.map(skill => `<span class="skill-tag">${skill.name}</span>`).join('')}
                            ${char.skills.length === 0 ? '<span class="skill-tag">Nenhuma</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('bestCharacterDisplay').innerHTML = html;
        }

        function displayPopulation() {
            const maxFitness = population[0].fitness;
            const eliteSize = Math.floor(population.length * (parseInt(document.getElementById('eliteRate').value) / 100));

            const html = population.map((char, index) => {
                const isElite = index < eliteSize;
                const fitnessPercent = (char.fitness / maxFitness) * 100;

                return `
                    <div class="individual ${isElite ? 'elite' : ''}">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85em;">
                            <strong>${char.strength}-${char.dexterity}-${char.intelligence}-${char.vitality}-${char.luck}</strong>
                            <span>${isElite ? '‚≠ê' : ''}</span>
                        </div>
                        <div style="text-align: center; font-size: 1.1em; font-weight: bold; margin-bottom: 6px;">
                            ${char.fitness}
                        </div>
                        <div class="fitness-bar">
                            <div class="fitness-fill" style="width: ${fitnessPercent}%"></div>
                        </div>
                        <div class="mini-attributes">
                            <div class="mini-attr"><div>üí™</div><strong>${char.strength}</strong></div>
                            <div class="mini-attr"><div>üèÉ</div><strong>${char.dexterity}</strong></div>
                            <div class="mini-attr"><div>üß†</div><strong>${char.intelligence}</strong></div>
                            <div class="mini-attr"><div>‚ù§Ô∏è</div><strong>${char.vitality}</strong></div>
                            <div class="mini-attr"><div>üçÄ</div><strong>${char.luck}</strong></div>
                        </div>
                        <div style="margin-top: 6px; font-size: 0.75em; text-align: center;">
                            üéØ ${char.skills.length} skills
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('populationDisplay').innerHTML = html;
        }
    </script>
</body>
</html>
